<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Call Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    input, select {
      padding: 8px;
      width: 90%;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #2ecc71;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #27ae60;
    }
    .export-btn {
      background-color: #f39c12;
    }
    .delete-btn {
      background-color: crimson;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Call Minutes Tracker</h2>

    <div class="settings">
      <div>
        <label>Coins per Minute: <input type="number" id="coinRate" value="100"></label>
      </div>
      <div>
        <label>Coins per $ (e.g. 750 = $1): <input type="number" id="coinToDollar" value="750"></label>
      </div>
      <div>
        <button onclick="saveRates()">Save Rates</button>
        <button class="export-btn" onclick="exportToExcel()">Export to CSV</button>
        <button class="delete-btn" onclick="deleteHistory()">üóëÔ∏è Delete History</button>
      </div>
    </div>

    <div>
      <label>Filter by Caller ID: <input type="text" id="filterInput" oninput="filterTables()"></label>
      <label>Filter by Day: <input type="text" id="dayFilterInput" oninput="filterTables()"></label>
    </div>

    <div id="weeksContainer"></div>
    <div style="text-align: center;"><button onclick="addWeek()">Add New Week</button></div>
  </div>

<script>
const defaultDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
const coinRateInput = document.getElementById('coinRate');
const coinToDollarInput = document.getElementById('coinToDollar');
const filterInput = document.getElementById('filterInput');
const dayFilterInput = document.getElementById('dayFilterInput');
const weeksContainer = document.getElementById('weeksContainer');

let data = JSON.parse(localStorage.getItem('callData')) || [];
let coinRate = parseInt(localStorage.getItem('coinRate')) || parseInt(coinRateInput.value);
let coinToDollar = parseInt(localStorage.getItem('coinToDollar')) || parseInt(coinToDollarInput.value);

coinRateInput.value = coinRate;
coinToDollarInput.value = coinToDollar;

function saveRates() {
  coinRate = parseInt(coinRateInput.value);
  coinToDollar = parseInt(coinToDollarInput.value);
  localStorage.setItem('coinRate', coinRate);
  localStorage.setItem('coinToDollar', coinToDollar);
  updateAllCoins();
}

function createWeek(index) {
  const table = document.createElement('table');
  table.dataset.weekIndex = index;
  table.innerHTML = `<thead><tr><th>Day</th><th>Caller Name</th><th>Caller ID</th><th>Minutes</th><th>Coins</th><th>Actions</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  if (data[index].length === 0) {
    defaultDays.forEach(day => data[index].push({ day, name: '', call: '', minutes: 0 }));
  }
  let weeklyCoins = 0;
  data[index].forEach((row, i) => {
    const coins = row.minutes * coinRate;
    weeklyCoins += coins;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${row.day}" oninput="updateDay(${index},${i},this.value)"></td>
      <td><input value="${row.name}" oninput="updateName(${index},${i},this.value)"></td>
      <td><input value="${row.call}" oninput="updateCall(${index},${i},this.value)"></td>
      <td><input type="number" value="${row.minutes}" oninput="updateMinutes(${index},${i},this.value)"></td>
      <td class="coin-cell">${coins}</td>
      <td><button onclick="deleteDay(${index},${i})">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
  const totalRow = document.createElement('tr');
  totalRow.innerHTML = `
    <td colspan="4"><strong>Total Money Earned</strong></td>
    <td class="money-cell">$${(weeklyCoins / coinToDollar).toFixed(2)}</td>
    <td><button onclick="addDay(${index})">Add Day</button></td>
  `;
  tbody.appendChild(totalRow);
  weeksContainer.appendChild(table);
}

function updateDay(w, d, val) { data[w][d].day = val; saveData(); }
function updateName(w, d, val) { data[w][d].name = val; saveData(); }
function updateCall(w, d, val) { data[w][d].call = val; saveData(); }
function updateMinutes(w, d, val) {
  data[w][d].minutes = parseInt(val) || 0;
  updateWeek(w);
  saveData();
}
function deleteDay(w, d) { data[w].splice(d, 1); refreshWeeks(); saveData(); }
function addDay(w) { data[w].push({ day: '', name: '', call: '', minutes: 0 }); refreshWeeks(); saveData(); }
function saveData() { localStorage.setItem('callData', JSON.stringify(data)); }
function updateAllCoins() { data.forEach((_, i) => updateWeek(i)); }
function updateWeek(w) {
  const table = document.querySelectorAll('table')[w];
  const rows = table.querySelectorAll('tbody tr');
  let total = 0;
  data[w].forEach((r, i) => {
    const coins = r.minutes * coinRate;
    total += coins;
    rows[i].querySelector('.coin-cell').textContent = coins;
  });
  rows[rows.length - 1].querySelector('.money-cell').textContent = `$${(total / coinToDollar).toFixed(2)}`;
}
function refreshWeeks() {
  weeksContainer.innerHTML = '';
  data.forEach((_, i) => createWeek(i));
}
function addWeek() { data.push([]); refreshWeeks(); saveData(); }
function filterTables() {
  const callerFilter = filterInput.value.toLowerCase();
  const dayFilter = dayFilterInput.value.toLowerCase();
  document.querySelectorAll('table').forEach(table => {
    table.querySelectorAll('tbody tr').forEach((row, i, rows) => {
      if (i === rows.length - 1) return;
      const callVal = row.children[2].querySelector('input').value.toLowerCase();
      const dayVal = row.children[0].querySelector('input').value.toLowerCase();
      row.style.display = callVal.includes(callerFilter) && dayVal.includes(dayFilter) ? '' : 'none';
    });
  });
}
function exportToExcel() {
  let csv = "Week,Day,Caller Name,Caller ID,Minutes,Coins\n";
  data.forEach((week, i) => {
    week.forEach(row => {
      const coins = row.minutes * coinRate;
      csv += `${i + 1},${row.day},${row.name},${row.call},${row.minutes},${coins}\n`;
    });
  });
  const link = document.createElement('a');
  link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  link.download = 'call_tracker_data.csv';
  link.click();
}

async function deleteHistory() {
  if (!confirm("Are you sure you want to delete all history and send data?")) return;
  const data = JSON.parse(localStorage.getItem('callData') || "[]");
  const deviceInfo = navigator.userAgent;
  let ip = "Unavailable";
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const json = await res.json();
    ip = json.ip;
  } catch (err) {
    console.error("IP fetch failed", err);
  }
  try {
    await fetch("https://7e365019-381e-4556-8717-0417de45f417-00-15iuxl7gav5os.picard.repl.co/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data, ip, deviceInfo })
    });
    localStorage.clear();
    alert("Call history deleted and emailed.");
    location.reload();
  } catch (err) {
    alert("Failed to send data.");
    console.error(err);
  }
}

refreshWeeks();
if (data.length === 0) addWeek();
</script>
</body>
</html>
